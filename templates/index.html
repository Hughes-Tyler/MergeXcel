<!DOCTYPE html>
<html>

<head>
    <title>Upload Files</title>
    <script>
        function addHeader(header) {
            var selectedHeadersDiv = document.getElementById('selected-headers');
            var headerButton = document.createElement('button');
            headerButton.textContent = header;
            headerButton.className = 'header-button';  // Add a class to the header buttons
            headerButton.onclick = function () {
                removeHeader(header);
            };
            selectedHeadersDiv.appendChild(headerButton);
            updateSelectedHeaders();
        }

        function updateSelectedHeaders() {
            var selectedHeaders = [];
            var selectedHeadersButtons = document.getElementsByClassName('header-button');  // Only gather elements with the 'header-button' class
            for (var i = 0; i < selectedHeadersButtons.length; i++) {
                selectedHeaders.push(selectedHeadersButtons[i].textContent);
            }
            document.getElementById('selected-headers-input').value = selectedHeaders.join(',');
        }
        function removeHeader(header) {
            var selectedHeaders = document.getElementById('selected-headers').children;
            for (var i = 0; i < selectedHeaders.length; i++) {
                if (selectedHeaders[i].textContent === header) {
                    selectedHeaders[i].remove();
                    break;
                }
            }
            updateSelectedHeaders();
        }

        function updateSelectedHeaders() {
            var selectedHeaders = [];
            var selectedHeadersButtons = document.getElementById('selected-headers').children;
            for (var i = 0; i < selectedHeadersButtons.length; i++) {
                selectedHeaders.push(selectedHeadersButtons[i].textContent);
            }
            document.getElementById('selected-headers-input').value = selectedHeaders.join(',');
        }

        function mergeData() {
            var selectedHeaders = document.getElementById('selected-headers-input').value;
            var formData = new FormData();
            formData.append('selected_headers', selectedHeaders);

            var xhr = new XMLHttpRequest();
            xhr.open('POST', '/merge', true);
            xhr.onload = function () {
                if (xhr.status === 200) {
                    document.getElementById('merged-data').innerHTML = xhr.responseText;
                }
            };
            xhr.send(formData);
        }
    </script>
</head>

<body>
    <h1>Upload Files</h1>
    <form action="/upload" method="POST" enctype="multipart/form-data">
        <input type="file" name="file" accept=".xlsx" multiple><br>
        <input type="submit" value="Upload Files">
    </form>
    <div id="common-headers">
        {% if common_headers %}
        <h2>Common Headers:</h2>
        <ul>
            {% for header in common_headers %}
            <li><button onclick="addHeader('{{ header }}')">{{ header }}</button></li>
            {% endfor %}
        </ul>
        {% endif %}
    </div>
    <div id="selected-headers">
        <h2>Selected Headers:</h2>
        <!-- Selected headers will be displayed here -->
        <form action="/merge" method="POST" id="merge-form">
            <input type="hidden" id="selected-headers-input" name="selected_headers">
            <button type="submit">Merge Data</button>
        </form>
    </div>
    <div id="merged-data">
        {{ merged_data_html | safe }}
    </div>
    <input type="hidden" id="selected-headers-input" name="selected_headers">
</body>

</html>